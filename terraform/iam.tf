resource "oci_identity_dynamic_group" "oci-ccm" {
  name           = "${var.cluster_name}-oci-ccm"
  compartment_id = var.tenancy_ocid # tenancy_ocid, compartment_ocid and domain_ocid doesn't work
  description    = "Instance access"
  matching_rule  = "ALL {instance.compartment.id = '${var.compartment_ocid}'}"
}

locals {
  ns_type_name   = strcontains(var.compartment_ocid, ".tenancy.") ? "tenancy" : "compartment"
  ns_select_name = strcontains(var.compartment_ocid, ".compartment.") ? data.oci_identity_compartment.this.name : ""
}

resource "oci_identity_policy" "oci-ccm" {
  name           = "${var.cluster_name}-oci-ccm"
  compartment_id = var.tenancy_ocid
  description    = "Instance access"
  statements = [
    // LoadBalancer Services
    "Allow dynamic-group ${oci_identity_dynamic_group.oci-ccm.name} to read instance-family in ${local.ns_type_name} ${local.ns_select_name}",
    "Allow dynamic-group ${oci_identity_dynamic_group.oci-ccm.name} to use virtual-network-family in ${local.ns_type_name} ${local.ns_select_name}",
    "Allow dynamic-group ${oci_identity_dynamic_group.oci-ccm.name} to manage load-balancers in ${local.ns_type_name} ${local.ns_select_name}",
    "Allow dynamic-group ${oci_identity_dynamic_group.oci-ccm.name} to manage security-lists in ${local.ns_type_name} ${local.ns_select_name}",
    // Volumes
    "Allow dynamic-group ${oci_identity_dynamic_group.oci-ccm.name} to manage volumes in ${local.ns_type_name} ${local.ns_select_name}",
    "Allow dynamic-group ${oci_identity_dynamic_group.oci-ccm.name} to manage file-systems in ${local.ns_type_name} ${local.ns_select_name}",
  ]
}

# still lacking some permissions
#oci-csi-controller-driver 2025-03-02T23:54:32.793Z    INFO    BV    client/volume_attachment.go:156    OPC Request ID recorded for AttachVolume call.    {"component": "csi-controller", "service": "compute" ││ , "verb": "create", "resource": "volume_attachment", "volumeID": "ocid1.volume.oc1.eu-frankfurt-1.abtheljrft7miu4q6c7vkgp4x6jxqnjjsqiong5nggxwqactxhsq6hrgh66q", "instanceID": "ocid1.instance.oc1.eu-frankfu ││ rt-1.antheljrtxk2sqacbqg7bvf4uikmqom6l2rwzgjbif7leos54rpmscwtwmyq", "OpcRequestId": "32e6a7bf0810821b2e02e1f60e5884ff/0C134C0E4316756D9B56171F7D0ED87E/61A93BDF67899A72441B36AB5DFD7FA1", "statusCode": 404}  ││
#oci-csi-controller-driver 2025-03-02T23:54:32.793Z    INFO    BV    driver/bv_controller.go:726    failed iscsi attachment instance to volume.    {"component": "csi-controller", "volumeID": "ocid1.volume.o ││ c1.eu-frankfurt-1.abtheljrft7miu4q6c7vkgp4x6jxqnjjsqiong5nggxwqactxhsq6hrgh66q", "nodeId": "cluster-control-plane-1", "csiOperation": "attach", "service": "compute", "verb": "create", "resource": "volumeAt ││ tachment", "statusCode": 404, "instanceID": "ocid1.instance.oc1.eu-frankfurt-1.antheljrtxk2sqacbqg7bvf4uikmqom6l2rwzgjbif7leos54rpmscwtwmyq", "error": "Error returned by Compute Service. Http Status Code:  ││ 404. Error Code: NotAuthorizedOrNotFound. Opc request id: 32e6a7bf0810821b2e02e1f60e5884ff/0C134C0E4316756D9B56171F7D0ED87E/61A93BDF67899A72441B36AB5DFD7FA1. Message: Authorization failed or requested reso ││ urce not found.\nOperation Name: AttachVolume\nTimestamp: 2025-03-02 23:54:30 +0000 GMT\nClient Version: Oracle-GoSDK/65.79.0\nRequest Endpoint: POST https://iaas.eu-frankfurt-1.oraclecloud.com/20160918/vo ││ lumeAttachments\nTroubleshooting Tips: See https://docs.oracle.com/iaas/Content/API/References/apierrors.htm#apierrors_404__404_notauthorizedornotfound for more information about resolving this error.\nAls ││ o see https://docs.oracle.com/iaas/api/#/en/iaas/20160918/VolumeAttachment/AttachVolume for details on this operation's requirements.\nTo get more info on the failing request, you can set OCI_GO_SDK_DEBUG  ││ env var to info or higher level to log the request/response details.\nIf you are unable to resolve this Compute issue, please contact Oracle support and provide them this full error message.", "errorVerbos ││ e": "Error returned by Compute Service. Http Status Code: 404. Error Code: NotAuthorizedOrNotFound. Opc request id: 32e6a7bf0810821b2e02e1f60e5884ff/0C134C0E4316756D9B56171F7D0ED87E/61A93BDF67899A72441B36A ││ B5DFD7FA1. Message: Authorization failed or requested resource not found.\nOperation Name: AttachVolume\nTimestamp: 2025-03-02 23:54:30 +0000 GMT\nClient Version: Oracle-GoSDK/65.79.0\nRequest Endpoint: PO ││ ST https://iaas.eu-frankfurt-1.oraclecloud.com/20160918/volumeAttachments\nTroubleshooting Tips: See https://docs.oracle.com/iaas/Content/API/References/apierrors.htm#apierrors_404__404_notauthorizedornotf ││ ound for more information about resolving this error.\nAlso see https://docs.oracle.com/iaas/api/#/en/iaas/20160918/VolumeAttachment/AttachVolume for details on this operation's requirements.\nTo get more  ││ info on the failing request, you can set OCI_GO_SDK_DEBUG env var to info or higher level to log the request/response details.\nIf you are unable to resolve this Compute issue, please contact Oracle suppor ││ t and provide them this full error message.\ngithub.com/oracle/oci-cloud-controller-manager/pkg/oci/client.(*client).AttachVolume\n\t/go/src/github.com/oracle/oci-cloud-controller-manager/pkg/oci/client/vo ││ lume_attachment.go:160\ngithub.com/oracle/oci-cloud-controller-manager/pkg/csi/driver.(*BlockVolumeControllerDriver).ControllerPublishVolume\n\t/go/src/github.com/oracle/oci-cloud-controller-manager/pkg/cs ││ i/driver/bv_controller.go:723\ngithub.com/container-storage-interface/spec/lib/go/csi._Controller_ControllerPublishVolume_Handler.func1\n\t/go/src/github.com/oracle/oci-cloud-controller-manager/vendor/gith ││ ub.com/container-storage-interface/spec/lib/go/csi/csi_grpc.pb.go:487\ngithub.com/oracle/oci-cloud-controller-manager/pkg/csi/driver.(*Driver).Run.func1\n\t/go/src/github.com/oracle/oci-cloud-controller-ma ││ nager/pkg/csi/driver/driver.go:338\ngithub.com/container-storage-interface/spec/lib/go/csi._Controller_ControllerPublishVolume_Handler\n\t/go/src/github.com/oracle/oci-cloud-controller-manager/vendor/githu ││ b.com/container-storage-interface/spec/lib/go/csi/csi_grpc.pb.go:489\ngoogle.golang.org/grpc.(*Server).processUnaryRPC\n\t/go/src/github.com/oracle/oci-cloud-controller-manager/vendor/google.golang.org/grp ││ c/server.go:1379\ngoogle.golang.org/grpc.(*Server).handleStream\n\t/go/src/github.com/oracle/oci-cloud-controller-manager/vendor/google.golang.org/grpc/server.go:1790\ngoogle.golang.org/grpc.(*Server).serv ││ eStreams.func2.1\n\t/go/src/github.com/oracle/oci-cloud-controller-manager/vendor/google.golang.org/grpc/server.go:1029\nruntime.goexit\n\t/usr/local/go/src/runtime/asm_arm64.s:1222"}                       ││
#oci-csi-controller-driver 2025-03-02T23:54:32.794Z    ERROR    BV    driver/driver.go:340    Failed to process gRPC request.    {"component": "csi-controller", "error": "rpc error: code = Internal desc = f ││ ailed iscsi attachment instance to volume : Error returned by Compute Service. Http Status Code: 404. Error Code: NotAuthorizedOrNotFound. Opc request id: 32e6a7bf0810821b2e02e1f60e5884ff/0C134C0E4316756D9 ││ B56171F7D0ED87E/61A93BDF67899A72441B36AB5DFD7FA1. Message: Authorization failed or requested resource not found.\nOperation Name: AttachVolume\nTimestamp: 2025-03-02 23:54:30 +0000 GMT\nClient Version: Ora ││ cle-GoSDK/65.79.0\nRequest Endpoint: POST https://iaas.eu-frankfurt-1.oraclecloud.com/20160918/volumeAttachments\nTroubleshooting Tips: See https://docs.oracle.com/iaas/Content/API/References/apierrors.htm ││ #apierrors_404__404_notauthorizedornotfound for more information about resolving this error.\nAlso see https://docs.oracle.com/iaas/api/#/en/iaas/20160918/VolumeAttachment/AttachVolume for details on this  ││ operation's requirements.\nTo get more info on the failing request, you can set OCI_GO_SDK_DEBUG env var to info or higher level to log the request/response details.\nIf you are unable to resolve this Comp ││ ute issue, please contact Oracle support and provide them this full error message.", "method": "/csi.v1.Controller/ControllerPublishVolume", "request": "{\"node_id\":\"cluster-control-plane-1\",\"volume_ca ││ pability\":{\"AccessType\":{\"Mount\":{}},\"access_mode\":{\"mode\":1}},\"volume_context\":{\"attachment-type\":\"\",\"needResize\":\"false\",\"newSize\":\"\",\"storage.kubernetes.io/csiProvisionerIdentity ││ \":\"1740959062624-4354-blockvolume.csi.oraclecloud.com\",\"vpusPerGB\":\"10\"},\"volume_id\":\"ocid1.volume.oc1.eu-frankfurt-1.abtheljrft7miu4q6c7vkgp4x6jxqnjjsqiong5nggxwqactxhsq6hrgh66q\"}"}